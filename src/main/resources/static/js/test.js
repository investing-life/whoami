// json
data = [
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": 1,
  "text": "쉽게 만족한다.",
  "original_text": "Am easy to satisfy.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "알기 어려운 사람이다.",
  "original_text": "Am hard to get to know.",
  "label": "Extraversion"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "쉽게 좌절하지 않는다.",
  "original_text": "Am not easily frustrated.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "추상적인 아이디어에 관심이 없다.",
  "original_text": "Am not interested in abstract ideas.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "이론적인 토론에 관심이 없다.",
  "original_text": "Am not interested in theoretical discussions.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "자주 기분이 좋지 않다.",
  "original_text": "Am often down in the dumps.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "개인적인 이익을 위해 움직인다.",
  "original_text": "Am out for my own personal gain.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "자기 자신에게 매우 만족한다.",
  "original_text": "Am very pleased with myself.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "타인과의 접촉을 피한다.",
  "original_text": "Avoid contacts with others.",
  "label": "Extraversion"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "철학적인 논의를 피한다.",
  "original_text": "Avoid philosophical discussions.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "예술의 중요성을 믿는다.",
  "original_text": "Believe in the importance of art.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "자신이 다른 사람보다 낫다고 믿는다.",
  "original_text": "Believe that I am better than others.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": 1,
  "text": "다른 사람들이 선의를 갖고 있다고 믿는다.",
  "original_text": "Believe that others have good intentions.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "예술가를 지원하기 위해 과도한 세금이 지출된다고 믿는다.",
  "original_text": "Believe that too much tax money goes to support artists.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "어떤 것에 대해서도 아름답게 말할 수 있다.",
  "original_text": "Can say things beautifully.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": 1,
  "text": "자신의 계획을 잘 실행한다.",
  "original_text": "Carry out my plans.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "대화의 수준을 더 높게 이끌어 간다.",
  "original_text": "Carry the conversation to a higher level.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "사람들의 기분을 좋게 만든다.",
  "original_text": "Cheer people up.",
  "label": "Extraversion"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": 1,
  "text": "해야 할 일을 잘 완수한다.",
  "original_text": "Complete tasks successfully.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "다른 사람들의 생각에 반박하곤 한다.",
  "original_text": "Contradict others.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "다른 사람들을 비판한다.",
  "original_text": "Cut others to pieces.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "자신을 싫어한다.",
  "original_text": "Dislike myself.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "딱 필요한 만큼만 일한다.",
  "original_text": "Do just enough work to get by.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "미술관에 가는 것을 즐기지 않는다.",
  "original_text": "Do not enjoy going to art museums.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "예술을 좋아하지 않는다.",
  "original_text": "Do not like art.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "시를 좋아하지 않는다.",
  "original_text": "Do not like poetry.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "하고 있는 일에 집중하지 못한다.",
  "original_text": "Don't put my mind on the task at hand.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "일을 끝까지 해내지 못한다.",
  "original_text": "Don't see things through.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "새로운 아이디어에 관심이 많다.",
  "original_text": "Enjoy hearing new ideas.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "여러 가지에 대해 생각하는 것을 즐긴다.",
  "original_text": "Enjoy thinking about things.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "공상하기를 즐긴다.",
  "original_text": "Enjoy wild flights of fantasy.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "최악의 상황을 걱정한다.",
  "original_text": "Fear for the worst.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": 1,
  "text": "시작한 것을 끝낸다.",
  "original_text": "Finish what I start.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": 1,
  "text": "계획을 세우면 잘 지킨다.",
  "original_text": "Follow through with my plans.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "새로운 아이디어에 흥분한다.",
  "original_text": "Get excited by new ideas.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "풍부한 어휘력을 가지고 있다.",
  "original_text": "Have a rich vocabulary.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "날카롭게 말하는 편이다.",
  "original_text": "Have a sharp tongue.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "구체적인 상상력을 가지고 있다.",
  "original_text": "Have a vivid imagination.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "추상적인 아이디어를 이해하는 것에 어려움이 있다.",
  "original_text": "Have difficulty understanding abstract ideas.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "다른 사람들과 거리를 둔다.",
  "original_text": "Keep others at a distance.",
  "label": "Extraversion"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "일을 끝내지 않은 채로 놔둔다.",
  "original_text": "Leave things unfinished.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "다른 사람들에게 많은 것을 요구한다.",
  "original_text": "Make demands on others.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "일을 망치곤 한다.",
  "original_text": "Mess things up.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.9,
  "key": -1,
  "text": "시작하려면 동기부여가 필요하다.",
  "original_text": "Need a push to get started.",
  "label": "Conscientiousness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "자주 우울하다.",
  "original_text": "Often feel blue.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "일상적인 것들에 깊은 의미를 찾지 않는다.",
  "original_text": "Rarely look for a deeper meaning in things.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "압박감 속에서도 침착할 수 있다.",
  "original_text": "Remain calm under pressure.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": 1,
  "text": "다른 사람들을 존중한다.",
  "original_text": "Respect others.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "다른 사람들과 가까워지는 것이 부담스럽다.",
  "original_text": "Retreat from others.",
  "label": "Extraversion"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": -1,
  "text": "화를 별로 내지 않는다.",
  "original_text": "Seldom get mad.",
  "label": "Neuroticism"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": -1,
  "text": "다른 사람들에게 숨은 동기가 있는지 의심한다.",
  "original_text": "Suspect hidden motives in others.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": -1,
  "text": "보수 정치 후보에게 투표하는 경향이 있다.",
  "original_text": "Tend to vote for conservative political candidates.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.89,
  "key": 1,
  "text": "진보 정치 후보에게 투표하는 경향이 있다.",
  "original_text": "Tend to vote for liberal political candidates.",
  "label": "Openness To Experience"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": 1,
  "text": "모든 사람들을 동등하게 대한다.",
  "original_text": "Treat all people equally.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.85,
  "key": 1,
  "text": "다른 사람들의 말을 신뢰한다.",
  "original_text": "Trust what people say.",
  "label": "Agreeableness"
 },
 {
  "instrument": "NEO5-20",
  "alpha": 0.91,
  "key": 1,
  "text": "다른 사람들과 빠르게 가까워진다.",
  "original_text": "Warm up quickly to others.",
  "label": "Extraversion"
 }
]

// 인적 사항 관리
function validateSex(e) {
    document.querySelector('#sex-input-invalid').style.display='none';
    if (!inlineRadio1.checked && !inlineRadio2.checked) {
        document.querySelector('#sex-input-invalid').style.display='block';
        return false;
    }
    return true;
}

var shouldNotShowWarning = true;
window.onbeforeunload = function() {
    if (!shouldNotShowWarning) {
        return "경고 메시지"; // 경고 메시지를 반환하여 경고창을 표시합니다.
    }
};

function startTest() {
    shouldNotShowWarning = false;
    document.getElementById('guide').style.display = 'none';
    document.getElementById('info').style.display = 'block';
}

function goBack() {
    document.getElementById('info').style.display = 'none';
    document.getElementById('guide').style.display = 'block';
}

function goNext() {
    document.getElementById('info').style.display = 'none';
    document.getElementById('page-1').style.display = 'block';
}

function enableNext() {
    document.getElementById('next_0').disabled = false;
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 0부터 55까지의 숫자 리스트 생성
const numberList = Array.from({ length: data.length }, (_, index) => index);
// 리스트 섞기
const shuffledList = shuffleArray(numberList);


var num = 10
createTable();

function validateButton() {
    for (let i = 1; i < Math.ceil(data.length / num) + 1; i++) {
        answeredAll = true;
        for (let j = (i - 1) * num; j < i * num && j < data.length; j++) {
            if (!(document.querySelectorAll('input[name="btnradio-' + j + '"]')[0].checked ||
            document.querySelectorAll('input[name="btnradio-' + j + '"]')[1].checked ||
            document.querySelectorAll('input[name="btnradio-' + j + '"]')[2].checked ||
            document.querySelectorAll('input[name="btnradio-' + j + '"]')[3].checked ||
            document.querySelectorAll('input[name="btnradio-' + j + '"]')[4].checked)) {
                answeredAll = false;
                break;
            }
        }
        if (answeredAll) {
            document.getElementById('next_' + i).disabled = false;
        }
    }
}

function sendResult() {
    // 만약 답하지 않은 문항이 있다면 return false
    for (let j = 0; j < data.length; j++) {
        var empty = 0;
        for (let k = 0; k < 5; k++) {
            if (!document.querySelectorAll('input[name="btnradio-' + j + '"]')[k].checked) {
                empty++;
            }
            if (empty == 5) {
                return false;
            }
        }
    }

    shuffledResult = []

    for (let j = 0; j < data.length; j++) {
        for (let k = 0; k < 5; k++) {
            if (document.querySelectorAll('input[name="btnradio-' + j + '"]')[k].checked) {
                shuffledResult.push(k + 1);
                break;
            }
        }
    }
    result = new Array(data.length);
    for (let j = 0; j < data.length; j++) {
        result[shuffledList[j]] = shuffledResult[j];
    }
    opennessList = [];
    conscientiousnessList = [];
    extraversionList = [];
    agreeablenessList = [];
    neuroticismList = [];

    original_result = [...result];
    // key -1인 거 뒤집기
    for (let j = 0; j < data.length; j++) {
        if (data[j].key == -1) {
            result[j] = 6 - result[j]
        }
    }

    for (let j = 0; j < data.length; j++) {
        if (data[j].label == 'Openness To Experience') {
            opennessList.push(result[j]);
        } else if (data[j].label == 'Conscientiousness') {
            conscientiousnessList.push(result[j]);
        } else if (data[j].label == 'Extraversion') {
            extraversionList.push(result[j]);
        } else if (data[j].label == 'Agreeableness') {
            agreeablenessList.push(result[j]);
        } else if (data[j].label == 'Neuroticism') {
            neuroticismList.push(result[j]);
        }
    }


    var sum = 0;
    opennessList.forEach(function(num) {
      sum += num;
    });
    openness = sum / opennessList.length;

    sum = 0;
    conscientiousnessList.forEach(function(num) {
      sum += num;
    });
    conscientiousness = sum / conscientiousnessList.length;

    sum = 0;
    extraversionList.forEach(function(num) {
      sum += num;
    });
    extraversion = sum / extraversionList.length;

    sum = 0;
    agreeablenessList.forEach(function(num) {
      sum += num;
    });
    agreeableness = sum / agreeablenessList.length;

    sum = 0;
    neuroticismList.forEach(function(num) {
      sum += num;
    });
    neuroticism = sum / neuroticismList.length;

    var resultString = ''
    for (j = 0; j < data.length; j++) {
        resultString += original_result[j];
    }

    // 인적사항
    sex = '남';
    if (document.getElementById('inlineRadio2').checked) {
        sex = '여';
    }
    age = '10대 이하';
    if (document.getElementById('inlineRadio4').checked) {
        age = '20대';
    } else if (document.getElementById('inlineRadio5').checked) {
        age = '30대';
    } else if (document.getElementById('inlineRadio6').checked) {
        age = '40대';
    } else if (document.getElementById('inlineRadio7').checked) {
        age = '50대';
    } else if (document.getElementById('inlineRadio8').checked) {
        age = '60대 이상';
    }

    // CSRF 토큰 가져오기
    var csrfToken = $("meta[name='_csrf']").attr("content");
    var csrfHeader = $("meta[name='_csrf_header']").attr("content");

    $.ajax({
        url: '/home/rooms/' + link + '/test',
        method: 'POST',
        data: { sex: sex, age: age, testResult: resultString, openness: openness, conscientiousness: conscientiousness, extraversion: extraversion, agreeableness: agreeableness, neuroticism: neuroticism },
        beforeSend: function(xhr) {
            xhr.setRequestHeader(csrfHeader, csrfToken); // CSRF 토큰을 요청 헤더에 포함
        },
        async: false,
        success: function(response) {
            shouldNotShowWarning = true;
            window.location.href = response.redirectUrl;
        },
        error: function(xhr, status, error) {
            alert('전송 실패');
        }
    });

}

function createTable() {
    for (let i = 1; i < Math.ceil(data.length / num) + 1; i++) {
        // 가장 바깥쪽 div
        var container = document.createElement('div');
        container.style.display = 'none';
        container.setAttribute('id', 'page-' + i);

        // 테이블 요소 생성
        var table = document.createElement('table');
        table.classList.add('table');

        // 테이블 헤더 생성
        var thead = document.createElement('thead');
        var headerRow = document.createElement('tr');
        headerRow.style.textAlign = 'center';

        // 첫 번째 헤더 셀
        var headerCell1 = document.createElement('th');
        headerCell1.setAttribute('rowspan', '2');
        headerCell1.textContent = '항목';
        headerRow.appendChild(headerCell1);

        // 두 번째 헤더 셀
        var headerCell2 = document.createElement('th');
        headerCell2.setAttribute('colspan', '5');
        headerCell2.textContent = '점수';
        headerRow.appendChild(headerCell2);

        thead.appendChild(headerRow);
        table.appendChild(thead);

        // 테이블 바디 생성
        var tbody = document.createElement('tbody');

        for (let j = (i - 1) * num; j < i * num && j < data.length; j++) {
            var bodyRow = document.createElement('tr');
            bodyRow.style.verticalAlign = 'middle';

            // 셀 생성
            var cell = document.createElement('td');
            cell.textContent = data[shuffledList[j]].text;

            // radio 버튼 생성

            // td 요소를 생성합니다.
            tdElement = document.createElement('td');
            tdElement.setAttribute('colspan', '5');

            // div 요소를 생성합니다.
            divElement = document.createElement('div');
            divElement.classList.add('btn-group');
            divElement.setAttribute('role', 'group');
            divElement.setAttribute('aria-label', 'Basic radio toggle button group');

            // 라디오 버튼과 라벨을 생성하고 div 요소에 추가합니다.
            for (let k = 1; k < 6; k++) {
                radioInput = document.createElement('input');
                radioInput.setAttribute('type', 'radio');
                radioInput.classList.add('btn-check');
                radioInput.setAttribute('name', `btnradio-${j}`);
                radioInput.setAttribute('id', `btnradio-${j}-${k}`);
                radioInput.setAttribute('autocomplete', 'off');
                radioInput.onclick = function() {
                    validateButton();
                }

                label = document.createElement('label');
                label.classList.add('btn', 'btn-outline-secondary');
                label.setAttribute('for', `btnradio-${j}-${k}`);
                label.textContent = k;

                divElement.appendChild(radioInput);
                divElement.appendChild(label);
            }

            // div 요소를 td 요소에 추가합니다.
            tdElement.appendChild(divElement);

            // text 부분 추가
            bodyRow.appendChild(cell);

            // td 요소를 부모 요소에 추가합니다.
            bodyRow.appendChild(tdElement);

            tbody.appendChild(bodyRow);
        }

        table.appendChild(tbody);

        // 생성한 테이블을 원하는 위치에 추가
        container.appendChild(table);

        btnContainer = document.createElement('div');
        btnContainer.style.textAlign = 'center';

        // 페이지 수 표시
        page = document.createElement('div');
        page.style.marginBottom = '0.5rem';
        page.textContent = i + ' / ' + (Math.ceil(data.length / num));
        btnContainer.appendChild(page);

        // 이전 다음 버튼 추가;
        btnGroup = document.createElement('div');
        btnGroup.classList.add('btn-group');

        // 이전 버튼
        btnPrev = document.createElement('button');
        btnPrev.setAttribute('type', 'button');
        btnPrev.classList.add('btn');
        btnPrev.classList.add('btn-outline-warning');
        btnPrev.textContent = '이전';
        btnPrev.setAttribute('id', 'prev_' + i);
        if (i == 1) {
            btnPrev.onclick = function() {
                document.getElementById('page-' + i).style.display = 'none';
                document.getElementById('info').style.display = 'block';
            }
        } else {
            btnPrev.onclick = function() {
                document.getElementById('page-' + i).style.display = 'none';
                document.getElementById('page-' + (i - 1)).style.display = 'block';
            };
        }
        // 다음 버튼
        btnNext = document.createElement('button');
        btnNext.setAttribute('type', 'button');
        btnNext.classList.add('btn');
        btnNext.classList.add('btn-warning');
        btnNext.setAttribute('disabled', true);
        btnNext.setAttribute('id', 'next_' + i);
        if (i == Math.ceil(data.length / num)) {
            btnNext.textContent = '완료';
            btnNext.onclick = function() {
                sendResult();
            }
        } else {
            btnNext.textContent = '다음';
            btnNext.onclick = function() {
                document.getElementById('page-' + i).style.display = 'none';
                document.getElementById('page-' + (i + 1)).style.display = 'block';
            };

         }

        btnGroup.appendChild(btnPrev);
        btnGroup.appendChild(btnNext);

        btnContainer.appendChild(btnGroup);
        container.appendChild(btnContainer);

        document.getElementById('container').appendChild(container);

    }

}

